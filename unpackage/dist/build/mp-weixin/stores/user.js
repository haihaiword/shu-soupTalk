"use strict";const e=require("../common/vendor.js");e.Vs.importObject("uni-id-co");const t=e.Vs.database().collection("uni-id-users"),n=e.defineStore("user",(()=>{let n=e.index.getStorageSync("uni-id-pages-userInfo")||{};const i=e.ref(n),o=e.ref(0!=Object.keys(n).length);async function s(n=!1){if(n)t.where("_id==$env.uid").update(n).then((t=>{t.result.updated?(e.index.showToast({title:"更新成功",icon:"none",duration:3e3}),a(n)):e.index.showToast({title:"没有改变",icon:"none",duration:3e3})}));else{const n=e.Vs.importObject("uni-id-co",{customUI:!0});try{let e=await t.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar,wx_openid.mp as openid,register_date").get();const i=await n.getRealNameInfo();a({...e.result.data[0],realNameAuth:i})}catch(i){a({},{cover:!0}),console.error(i.message,i.errCode)}}}async function a(t,{cover:n}={cover:!1}){let s=n?t:Object.assign(i.value,t);return i.value=Object.assign({},s),o.value=0!=Object.keys(i.value).length,e.index.setStorageSync("uni-id-pages-userInfo",i.value),t}return{userInfo:i,hasLogin:o,loginSuccess:function(t={}){const{showToast:n=!0,toastText:i="登录成功",autoBack:o=!0,uniIdRedirectUrl:a="",passwordConfirmed:r}=t;n&&e.index.showToast({title:i,icon:"none",duration:3e3}),s(),e.index.$emit("uni-id-pages-login-success"),o&&function(t={}){const{uniIdRedirectUrl:n=""}=t;let i=0,o=getCurrentPages();if(o.forEach(((e,t)=>{"login"==o[o.length-t-1].route.split("/")[3]&&i++})),n)return e.index.redirectTo({url:n,fail:t=>{e.index.switchTab({url:n,fail:e=>{console.log(t,e)}})}});if(i){const t=pagesJson.pages[0];return e.index.reLaunch({url:`/${t.path}`})}e.index.navigateBack({delta:i})}(a)},updateUserInfo:s}}));exports.useUserStore=n;
