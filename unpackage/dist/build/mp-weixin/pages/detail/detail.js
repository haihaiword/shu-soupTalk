"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/common.js");if(!Array){(e.resolveComponent("soup-tab-group")+e.resolveComponent("soup-text-content")+e.resolveComponent("comment-item")+e.resolveComponent("uni-load-more")+e.resolveComponent("interactive-bar")+e.resolveComponent("z-paging")+e.resolveComponent("comment-reply")+e.resolveComponent("uni-popup")+e.resolveComponent("share-posters"))()}Math||((()=>"../../components/soup-tab-group/soup-tab-group.js")+(()=>"../../components/soup-text-content/soup-text-content.js")+(()=>"../../components/comment-item/comment-item.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../components/interactive-bar/interactive-bar.js")+(()=>"../../uni_modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/comment-reply/comment-reply.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../components/share-posters/share-posters.js"))();const t={__name:"detail",setup(t){let n;const l=e.ref(null),i=e.Vs.database(),s=i.command,p=s.aggregate,u=e.ref({}),a=e.Vs.getCurrentUserInfo().uid,r=e.ref(null),m=e.ref(null),c=e.ref({}),d=e.ref(null),_=e.ref([]),f=e.ref(null),v=e.ref(!1);e.onLoad((e=>{n=e.scene?e.scene:e.id,console.log(e),h()}));const $=()=>{l.value.open(),d.value.focuFn()};e.index.$on("commentLike",(e=>{let o=_.value.findIndex((o=>o._id==e._id));_.value[o]={..._.value[o],...e}}));const h=async()=>{let{result:{errCode:e,data:t}}=await i.collection("soup-chicken").aggregate().match({status:1,is_delete:s.neq(!0),_id:n}).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:p.pipeline().match(s.expr(p.eq(["$_id","$$uid"]))).project({username:1,avatar:1}).done(),as:"userInfo"}).lookup({from:"soup-like",let:{soupID:"$_id"},pipeline:p.pipeline().match(s.expr(p.and([p.eq(["$like_type",0]),p.eq(["$$soupID","$soup_id"]),p.eq(["$user_id",a])]))).count("length").done(),as:"likeState"}).lookup({from:"soup-collection",let:{soupID:"$_id"},pipeline:p.pipeline().match(s.expr(p.and([p.eq(["$$soupID","$soup_id"]),p.eq(["$user_id",a])]))).count("length").done(),as:"collectionState"}).project({isLike:p.cond({if:p.gt([p.arrayElemAt(["$likeState.length",0]),0]),then:!0,else:!1}),collect_count:1,comment_count:1,isCollection:p.cond({if:p.gt([p.arrayElemAt(["$collectionState.length",0]),0]),then:!0,else:!1}),content:1,from:1,like_count:1,soup_type:1,view_count:1,userInfo:p.arrayElemAt(["$userInfo",0])}).end();if(0!=e)return o.showToast("信息有误，请重新刷新","none");console.log(t),u.value=t[0],c.value={soup_id:u.value._id,comment_type:0}},g=e=>{m.value=u.value,r.value.handleShow()};e.index.$on("commentRemove",(()=>{e.nextTick$1((()=>{f.value.refresh()}))}));const k=(e,o)=>{y(e,o)},y=async(e,o)=>{let t=(e-1)*o,{result:{errCode:l,data:u}}=await i.collection("soup-comments").aggregate().match({soup_id:n,comment_type:0}).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:p.pipeline().match(s.expr(p.eq(["$_id","$$uid"]))).project({username:1,avatar:1}).done(),as:"userInfo"}).lookup({from:"soup-comments",let:{id:"$_id"},pipeline:p.pipeline().match(s.expr(p.eq(["$reply_parent_id","$$id"]))).count("length").done(),as:"childCount"}).lookup({from:"soup-comments",let:{id:"$_id"},pipeline:p.pipeline().match(s.expr(p.eq(["$reply_parent_id","$$id"]))).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:p.pipeline().match(s.expr(p.eq(["$_id","$$uid"]))).project({username:1}).done(),as:"userInfo"}).project({comment_content:p.cond({if:p.eq(["$is_delete",!0]),then:"已被删除",else:"$comment_content"}),userInfo:p.arrayElemAt(["$userInfo",0])}).sort({like_count:-1}).limit(2).done(),as:"child"}).lookup({from:"soup-like",let:{commentID:"$_id"},pipeline:p.pipeline().match(s.expr(p.and([p.eq([n,"$soup_id"]),p.eq(["$$commentID","$comment_id"]),p.eq(["$user_id",a])]))).count("length").done(),as:"likeState"}).sort("comment_date desc").skip(t).limit(o).project({is_delete:1,like_count:1,comment_count:1,comment_type:1,comment_content:p.cond({if:p.eq(["$is_delete",!0]),then:"已被删除",else:"$comment_content"}),soup_id:1,child:1,comment_date:1,childCount:p.arrayElemAt(["$childCount.length",0]),userInfo:p.arrayElemAt(["$userInfo",0]),isLike:p.cond({if:p.gt([p.arrayElemAt(["$likeState.length",0]),0]),then:!0,else:!1})}).end();f.value.complete(u),0==u.length&&(v.value=!0),console.log(u)},b=()=>{o.showToast("发布成功"),l.value.close(),f.value.refresh()};return(o,t)=>e.e({a:u.value},u.value?e.e({b:e.p({type:u.value.soup_type}),c:e.p({lookState:!0,item:u.value}),d:_.value.length},_.value.length?{e:e.f(_.value,((o,t,n)=>({a:"f86816fb-3-"+n+",f86816fb-0",b:e.p({item:o,subReply:!0}),c:o._id})))}:{},{f:!_.value.length&&!v.value},_.value.length||v.value?{}:{g:e.p({status:"loading",showText:!1})},{h:e.o($),i:e.o(g),j:e.p({item:u.value,type:1}),k:e.sr(f,"f86816fb-0",{k:"paging"}),l:e.o(k),m:e.o((e=>_.value=e)),n:e.p({"empty-view-text":"抢先回复","empty-view-img":"http://cdn.uviewui.com/uview/empty/comment.png",modelValue:_.value})}):{},{o:e.sr(d,"f86816fb-7,f86816fb-6",{k:"commentRef"}),p:e.o(b),q:e.p({source:c.value}),r:e.sr(l,"f86816fb-6",{k:"commentPopup"}),s:e.p({type:"bottom"}),t:e.sr(r,"f86816fb-8",{k:"shareRef"}),v:e.p({info:m.value})})}},n=e._export_sfc(t,[["__scopeId","data-v-f86816fb"]]);wx.createPage(n);
