"use strict";const e=require("../../common/vendor.js"),n=require("../../utils/common.js");if(!Array){(e.resolveComponent("comment-item")+e.resolveComponent("uni-icons")+e.resolveComponent("z-paging")+e.resolveComponent("comment-reply")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../components/comment-item/comment-item.js")+(()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/comment-reply/comment-reply.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"reply",setup(o){const t=e.ref(e.index.getStorageSync("currentReply")||{}),r=e.ref(null),p=e.ref(null),i=e.Vs.database(),m=i.command,l=e.Vs.getCurrentUserInfo().uid,u=m.aggregate,s=e.ref([]),a=e.ref({soup_id:t.value.soup_id,comment_type:1,reply_parent_id:t.value._id,reply_user_id:t.value.userInfo._id,reply_comment_id:t.value._id,reply_user_name:t.value.userInfo.username}),c=e.ref(null),_=()=>{r.value.open(),c.value.focuFn()};e.index.$on("commentRemove",(()=>{e.nextTick$1((()=>{p.value.refresh()}))}));const d=e=>{_(),a.value={...a.value,reply_user_id:e.userInfo._id,reply_comment_id:e._id,reply_user_name:e.userInfo.username}};e.onUnload((()=>{e.index.removeStorageSync("currentReply")}));const f=(e,n)=>{y(e,n)},y=async(e,n)=>{let o=(e-1)*n,{result:{errCode:r,data:s}}=await i.collection("soup-comments").aggregate().match({soup_id:t.value.soup_id,comment_type:1,reply_parent_id:t.value._id}).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:u.pipeline().match(m.expr(u.eq(["$_id","$$uid"]))).project({username:1,avatar:1}).done(),as:"userInfo"}).lookup({from:"soup-comments",let:{reply_comment_id:"$reply_comment_id",reply_parent_id:"$reply_parent_id"},pipeline:u.pipeline().match(m.expr(u.and([u.neq(["$$reply_comment_id","$$reply_parent_id"]),u.eq(["$_id","$$reply_comment_id"])]))).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:u.pipeline().match(m.expr(u.eq(["$_id","$$uid"]))).project({username:1}).done(),as:"userInfo"}).project({comment_content:u.cond({if:u.eq(["$is_delete",!0]),then:"已被删除",else:"$comment_content"}),userInfo:u.arrayElemAt(["$userInfo",0])}).done(),as:"replyInfo"}).lookup({from:"soup-like",let:{commentID:"$_id"},pipeline:u.pipeline().match(m.expr(u.and([u.eq([t.value.soup_id,"$soup_id"]),u.eq(["$$commentID","$comment_id"]),u.eq(["$user_id",l])]))).count("length").done(),as:"likeState"}).sort({comment_date:-1}).skip(o).limit(n).project({is_delete:1,like_count:1,comment_count:1,comment_type:1,comment_content:u.cond({if:u.eq(["$is_delete",!0]),then:"已被删除",else:"$comment_content"}),soup_id:1,comment_date:1,userInfo:u.arrayElemAt(["$userInfo",0]),replyInfo:u.arrayElemAt(["$replyInfo",0]),isLike:u.cond({if:u.gt([u.arrayElemAt(["$likeState.length",0]),0]),then:!0,else:!1})}).end();p.value.complete(s)},v=()=>{n.showToast("发布成功"),r.value.close(),p.value.refresh(),a.value={...a.value,reply_user_id:t.value.userInfo._id,reply_comment_id:t.value._id,reply_user_name:t.value.userInfo.username}};return(n,o)=>({a:e.p({item:t.value,toplevel:!0}),b:e.f(s.value,((n,o,t)=>({a:e.o(d,n._id),b:"01f3788f-2-"+t+",01f3788f-0",c:e.p({item:n,reply:!0}),d:n._id}))),c:e.p({type:"paperplane",size:"26",color:"#333"}),d:e.o(_),e:e.sr(p,"01f3788f-0",{k:"paging"}),f:e.o(f),g:e.o((e=>s.value=e)),h:e.p({"empty-view-text":"抢先回复","empty-view-img":"http://cdn.uviewui.com/uview/empty/comment.png",modelValue:s.value}),i:e.sr(c,"01f3788f-5,01f3788f-4",{k:"commentRef"}),j:e.o(v),k:e.p({source:a.value}),l:e.sr(r,"01f3788f-4",{k:"commentPopup"}),m:e.p({type:"bottom"})})}},t=e._export_sfc(o,[["__scopeId","data-v-01f3788f"]]);wx.createPage(t);
