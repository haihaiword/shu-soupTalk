"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),t=require("../../utils/common.js");if(!Array){(e.resolveComponent("home-head")+e.resolveComponent("uni-load-more")+e.resolveComponent("soup-tab-group")+e.resolveComponent("soup-text-content")+e.resolveComponent("interactive-bar")+e.resolveComponent("uni-popup")+e.resolveComponent("share-posters"))()}Math||((()=>"../../components/home-head/home-head.js")+(()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../components/soup-tab-group/soup-tab-group.js")+(()=>"../../components/soup-text-content/soup-text-content.js")+(()=>"../../components/interactive-bar/interactive-bar.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../components/share-posters/share-posters.js"))();const a={__name:"index",setup(a){const n=e.ref([]),u=e.ref(0),s=e.ref(null),r=e.Vs.database(),l=r.command,i=l.aggregate,p=e.Vs.getCurrentUserInfo().uid,d=e.ref(5),c=e.ref(null),m=e.ref(null);e.onReady((()=>{e.index.getStorageSync("useState")||!1||s.value.open()})),e.index.$on("like",(e=>{console.log(e);let o=n.value.findIndex((o=>o._id==e._id));n.value[o]={...n.value[o],...e}}));const v=e=>{u.value=e.detail.current,n.value[u.value]&&!n.value[u.value].is_read?(n.value[u.value].is_read=!0,r.collection("soup-today").where("user_id==$cloudEnv_uid").update({soup_list:n.value})):console.log("重复操作")},_=e.computed((()=>u.value/n.value.length*100)),h=()=>{s.value.close(),e.index.setStorageSync("useState",!0)},g=async()=>{if(d.value<=0)return t.showToast("今天的鸡汤已经没有了");d.value--,await r.collection("soup-today").where(`user_id=="${p}"`).update({number:d.value}),f("ad")},f=async(e="get")=>{let{result:{data:o=[],errCode:a=-1}={}}=await r.collection("soup-today").where("user_id==$cloudEnv_uid").get();if(o.length&&"get"==e){if(0!=a)return t.showToast("信息错误，请重新刷新","none");n.value=[...n.value,...o[0].soup_list],d.value=o[0].number}else{let{result:{errCode:o,data:a}}=await r.collection("soup-chicken").aggregate().lookup({from:"soup-user-read",let:{soupID:"$_id"},pipeline:i.pipeline().match(l.expr(i.eq(["$user_id",p]))).project({soup_id:1}).done(),as:"readSoup"}).addFields({readSoup:i.map({input:"$readSoup",in:"$$this.soup_id"})}).match({status:1,is_delete:l.neq(!0)}).match(l.expr(i.cond({if:i.eq([e,"random"]),then:i.in(["$_id","$readSoup"]),else:i.not(i.in(["$_id","$readSoup"]))}))).lookup({from:"uni-id-users",let:{uid:"$user_id"},pipeline:i.pipeline().match(l.expr(i.eq(["$_id","$$uid"]))).project({username:1,avatar:1}).done(),as:"userInfo"}).sample({size:5}).limit(5).project({collect_count:1,comment_count:1,content:1,from:1,like_count:1,soup_type:1,view_count:1,userInfo:i.arrayElemAt(["$userInfo",0])}).addFields({}).end();if(0!=o)return t.showToast("信息错误，请重新刷新","none");if(0==a.length)return getSoup1("random");a[0].is_read=!0,n.value=[...n.value,...a],"ad"==e?r.collection("soup-today").where(`user_id=="${p}"`).update({soup_list:n.value}):r.collection("soup-today").add({user_id:p,soup_list:a}),console.log(a)}};return f(),(t,a)=>e.e({a:!n.value.length},n.value.length?{c:e.f(n.value,((o,t,a)=>({a:"1a380dba-2-"+a,b:e.p({type:o.soup_type}),c:"1a380dba-3-"+a,d:e.p({item:o,maxline:"5"}),e:`/pages/detail/detail?id=${o._id}`,f:e.o((e=>(e=>{m.value=n.value[e],c.value.handleShow()})(t)),t),g:"1a380dba-4-"+a,h:e.p({item:o}),i:t}))),d:e.o(g),e:e.t(d.value),f:e.o(v)}:{b:e.p({status:"loading",showText:!1})},{g:_.value+"%",h:o._imports_0,i:e.o(h),j:e.sr(s,"1a380dba-5",{k:"usePopup"}),k:e.o(h),l:e.o(h),m:e.p({type:"center"}),n:e.sr(c,"1a380dba-6",{k:"shareRef"}),o:e.p({info:m.value})})}},n=e._export_sfc(a,[["__scopeId","data-v-1a380dba"]]);wx.createPage(n);
