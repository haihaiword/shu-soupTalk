"use strict";const o=require("../../../../../../common/vendor.js"),t=require("../z-paging-utils.js"),l={props:{usePageScroll:{type:Boolean,default:t.u.gc("usePageScroll",!1)},scrollable:{type:Boolean,default:t.u.gc("scrollable",!0)},showScrollbar:{type:Boolean,default:t.u.gc("showScrollbar",!0)},scrollX:{type:Boolean,default:t.u.gc("scrollX",!1)},scrollToTopBounceEnabled:{type:Boolean,default:t.u.gc("scrollToTopBounceEnabled",!1)},scrollToBottomBounceEnabled:{type:Boolean,default:t.u.gc("scrollToBottomBounceEnabled",!0)},scrollWithAnimation:{type:Boolean,default:t.u.gc("scrollWithAnimation",!1)},scrollIntoView:{type:String,default:t.u.gc("scrollIntoView","")}},data:()=>({scrollTop:0,oldScrollTop:0,scrollViewStyle:{},scrollViewContainerStyle:{},scrollViewInStyle:{},pageScrollTop:-1,scrollEnable:!0,privateScrollWithAnimation:-1,cacheScrollNodeHeight:-1}),watch:{oldScrollTop(o){!this.usePageScroll&&this._scrollTopChange(o,!1)},pageScrollTop(o){this.usePageScroll&&this._scrollTopChange(o,!0)},usePageScroll:{handler(o){this.loaded&&this.autoHeight&&this._setAutoHeight(!o)},immediate:!0},finalScrollTop(o){this.renderPropScrollTop=o<6?0:10}},computed:{finalScrollWithAnimation(){if(-1!==this.privateScrollWithAnimation){const o=1===this.privateScrollWithAnimation;return this.privateScrollWithAnimation=-1,o}return this.scrollWithAnimation},finalScrollViewStyle(){return 1!=this.superContentZIndex&&(this.scrollViewStyle["z-index"]=this.superContentZIndex,this.scrollViewStyle.position="relative"),this.scrollViewStyle},finalScrollTop(){return this.usePageScroll?this.pageScrollTop:this.oldScrollTop},finalIsOldWebView(){return this.isOldWebView&&!this.usePageScroll}},methods:{scrollToTop(o,t=!0){this.useChatRecordMode&&t&&!this.isChatRecordModeAndNotInversion?this.scrollToBottom(o,!1):this.$nextTick((()=>{this._scrollToTop(o,!1)}))},scrollToBottom(o,t=!0){this.useChatRecordMode&&t&&!this.isChatRecordModeAndNotInversion?this.scrollToTop(o,!1):this.$nextTick((()=>{this._scrollToBottom(o)}))},scrollIntoViewById(o,t,l){this._scrollIntoView(o,t,l)},scrollIntoViewByNodeTop(o,t,l){this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this._scrollIntoViewByNodeTop(o,t,l)}))},scrollToY(o,t,l){this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this._scrollToY(o,t,l)}))},scrollIntoViewByIndex(o,t,l){this._scrollIntoView(o,t,l)},scrollIntoViewByView(o,t,l){this._scrollIntoView(o,t,l)},updatePageScrollTop(o){this.pageScrollTop=o},updatePageScrollTopHeight(){this._updatePageScrollTopOrBottomHeight("top")},updatePageScrollBottomHeight(){this._updatePageScrollTopOrBottomHeight("bottom")},updateLeftAndRightWidth(){this.finalIsOldWebView&&this.$nextTick((()=>this._updateLeftAndRightWidth(this.scrollViewContainerStyle,"zp-page")))},updateScrollViewScrollTop(o,t=!0){this.privateScrollWithAnimation=t?1:0,this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this.scrollTop=o,this.oldScrollTop=this.scrollTop}))},_onScrollToUpper(){this.$emit("scrolltoupper"),this.$emit("scrollTopChange",0),this.$nextTick((()=>{this.oldScrollTop=0}))},_onScrollToLower(o){(!o.detail||!o.detail.direction||"bottom"===o.detail.direction)&&this._onLoadingMore(this.useChatRecordMode?"click":"toBottom")},_scrollToTop(t=!0,l=!0){this.usePageScroll?this.$nextTick((()=>{o.index.pageScrollTo({scrollTop:0,duration:t?100:0})})):(this.privateScrollWithAnimation=t?1:0,this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this.scrollTop=0,this.oldScrollTop=this.scrollTop})))},async _scrollToBottom(t=!0){if(this.usePageScroll)this.$nextTick((()=>{o.index.pageScrollTo({scrollTop:Number.MAX_VALUE,duration:t?100:0})}));else try{this.privateScrollWithAnimation=t?1:0;const o=await this._getNodeClientRect(".zp-paging-container"),l=await this._getNodeClientRect(".zp-scroll-view"),e=o?o[0].height:0,i=l?l[0].height:0;e>i&&(this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this.scrollTop=e-i+this.virtualPlaceholderTopHeight,this.oldScrollTop=this.scrollTop})))}catch(l){}},_scrollIntoView(o,t=0,l=!1,e){try{this.scrollTop=this.oldScrollTop,this.$nextTick((()=>{this._getNodeClientRect("#"+o.replace("#",""),this.$parent).then((o=>{if(o){let i=o[0].top;this._scrollIntoViewByNodeTop(i,t,l),e&&e()}}))}))}catch(i){}},_scrollIntoViewByNodeTop(o,t=0,l=!1){this.isChatRecordModeAndInversion?this._getNodeClientRect(".zp-scroll-view").then((e=>{e&&this._scrollToY(e[0].height-o,t,l,!0)})):this._scrollToY(o,t,l,!0)},_scrollToY(l,e=0,i=!1,s=!1){this.privateScrollWithAnimation=i?1:0,t.u.delay((()=>{if(this.usePageScroll){s&&-1!==this.pageScrollTop&&(l+=this.pageScrollTop);const t=l-e;o.index.pageScrollTo({scrollTop:t,duration:i?100:0})}else s&&(l+=this.oldScrollTop),this.scrollTop=l-e}),10)},_scroll(o){this.$emit("scroll",o);const t=o.detail.scrollTop;this.finalUseVirtualList&&this._updateVirtualScroll(t,this.oldScrollTop-t),this.oldScrollTop=t;const l=o.detail.scrollHeight-this.oldScrollTop;!this.isIos&&this._checkScrolledToBottom(l)},_doCheckScrollViewShouldFullHeight(o){this.autoFullHeight&&this.usePageScroll&&this.isTotalChangeFromAddData?this.$nextTick((()=>{this._checkScrollViewShouldFullHeight(((t,l)=>{this._preCheckShowNoMoreInside(o,t,l)}))})):this._preCheckShowNoMoreInside(o)},async _checkScrollViewShouldFullHeight(o){try{const t=await this._getNodeClientRect(".zp-scroll-view"),l=await this._getNodeClientRect(".zp-paging-container-content");if(!t||!l)return;const e=l[0].height,i=t[0].top;this.isAddedData&&e+i<=this.windowHeight?(this._setAutoHeight(!0,t),o(t,l)):(this._setAutoHeight(!1),o(null,null))}catch(t){o(null,null)}},_scrollTopChange(o,t){this.$emit("scrollTopChange",o),this.$emit("update:scrollTop",o),this._checkShouldShowBackToTop(o);const l=o>5?6:0;t&&this.wxsPageScrollTop!==l?this.wxsPageScrollTop=l:t||this.wxsScrollTop===l||(this.wxsScrollTop=l,l>6&&(this.scrollEnable=!0))},_updatePageScrollTopOrBottomHeight(o){if(!this.usePageScroll)return;this._doCheckScrollViewShouldFullHeight(this.realTotalData);const l=`.zp-page-${o}`,e=`margin${o.slice(0,1).toUpperCase()+o.slice(1)}`;let i=this.safeAreaInsetBottom;this.$nextTick((()=>{t.u.delay((()=>{this._getNodeClientRect(l).then((t=>{if(t){let l=t[0].height;"bottom"===o?i&&(l+=this.safeAreaBottom):this.cacheTopHeight=l,this.$set(this.scrollViewStyle,e,`${l}px`)}else i&&this.$set(this.scrollViewStyle,e,`${this.safeAreaBottom}px`)}))}),0)}))}}};exports.scrollerModule=l;
