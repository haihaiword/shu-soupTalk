"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/common.js"),t=require("../../utils/tools.js"),u=require("../../stores/user.js");if(!Array){e.resolveComponent("uni-notice-bar")()}Math;const s={__name:"edit",setup(s){const l=e.Vs.importObject("soup-score"),o=u.useUserStore(),i=e.computed((()=>a.stateFormat(d.value.status))),n=e.Vs.importObject("subscribemsg"),r=e.Vs.database(),d=e.ref({soup_type:0,content:"",from:"",feedback:""}),v=e.ref(!1),c=e.ref(!1);let m;e.onLoad((a=>{m=a.id,console.log(e.Vs.getCurrentUserInfo()),m&&(e.index.showLoading({title:"加载中...",mask:!0}),b(),e.index.setNavigationBarTitle({title:"编辑鸡汤"}))}));const f=e=>{console.log(e),d.value.soup_type=Number(e.detail.value),2!=d.value.status&&(d.value.feedback="")},p=e=>{d.value.status=Number(e.detail.value)},_=async()=>{a.isAdminRole()||await e.index.requestSubscribeMessage({tmplIds:["Fct-1k8MQNi2XDWEq2q7QfsrCp3gDU4L5hCxshb_LGQ"]});try{if(v.value=!0,e.index.showLoading({title:"提交中"}),d.value.content=t.removeHtmlTags(d.value.content),""===d.value.content)return a.showToast("鸡汤内容不能为空","none",!1);let u,s,{soup_type:l,status:i,content:n,from:c,feedback:f}=d.value,p={soup_type:l,status:i,content:n,from:c,feedback:f};m?(a.isAdminRole()||(p.status=0),a.isAdminRole()&&(p.review_uid=o.userInfo._id),s=await r.collection("soup-chicken").doc(m).update(p)):(a.isAdminRole()&&(d.value.status=1),s=await r.collection("soup-chicken").add(d.value)),u=s.result.errCode,0===u&&(e.index.$emit("soupUpdate",{msg:"更新了"}),a.showToast("发表成功","success"),setTimeout((()=>e.index.navigateBack()),1e3),g(s.result.id))}catch(u){console.log(u),a.showToast(u.errMsg,"error")}finally{e.index.hideLoading(),v.value=!1}},g=u=>{if((m||a.isAdminRole())&&1===d.value.status){let{user_id:[{_id:a=e.Vs.getCurrentUserInfo().uid}={}]=[],_id:t=u}=d.value||{};l.soupAdd({user_id:a,soup_id:t}).then((e=>{}))}m&&!a.isAdminRole()&&n.sendSubscribeMessage({user_id:d.value.user_id[0]._id,thing1:i.value.text,time4:t.formatDate(Date.now()),thing5:d.value.feedback?d.value.feedback:"点击进入小程序查看"}).then((e=>{console.log(e)}))},b=async()=>{let t=await r.collection("soup-chicken").where({_id:m}).getTemp(),u=await r.collection("uni-id-users").field("_id,username,avatar").getTemp(),{result:{errCode:s,data:l}}=await r.collection(t,u).get();0===s&&(d.value=l[0],2===d.value.status||a.isAdminRole()||(c.value=!0)),e.index.hideLoading()};return(t,u)=>{var s,l,o,n;return e.e({a:null!=d.value.status&&!e.unref(a.isAdminRole)()},null==d.value.status||e.unref(a.isAdminRole)()?{}:{b:e.p({"background-color":i.value.bgColor,color:i.value.color,showIcon:!0,text:`通知：${i.value.text}，${0==d.value.status||1==d.value.status?"不允许再次编辑":d.value.feedback+"，修改后可再次提交"}。`})},{c:d.value.user_id&&e.unref(a.isAdminRole)()},d.value.user_id&&e.unref(a.isAdminRole)()?{d:(null==(l=null==(s=d.value)?void 0:s.user_id[0])?void 0:l.avatar)||"../../static/images/self.png",e:e.t((null==(n=null==(o=d.value)?void 0:o.user_id[0])?void 0:n.username)||"匿名")}:{},{f:v.value||c.value,g:0==d.value.soup_type,h:v.value||c.value,i:1==d.value.soup_type,j:e.o(f),k:v.value||c.value,l:d.value.content,m:e.o((e=>d.value.content=e.detail.value)),n:v.value||c.value,o:d.value.from,p:e.o((e=>d.value.from=e.detail.value)),q:e.unref(a.isAdminRole)()&&d.value._id},e.unref(a.isAdminRole)()&&d.value._id?e.e({r:e.f(e.unref(a.stateLists),((a,t,u)=>({a:a.value,b:a.color,c:a.value==d.value.status,d:e.t(a.text),e:a.value}))),s:e.o(p),t:2==d.value.status},2==d.value.status?{v:v.value||c.value,w:d.value.feedback,x:e.o((e=>d.value.feedback=e.detail.value))}:{}):{},{y:e.unref(a.isAdminRole)()},e.unref(a.isAdminRole)()?{z:e.o(_),A:c.value}:{B:e.o(_),C:c.value})}}},l=e._export_sfc(s,[["__scopeId","data-v-0680622c"]]);wx.createPage(l);
